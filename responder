#!/usr/bin/env python

import praw
import json
import re
import time

class Responder(object):
    def __init__(self, configFilename = 'config.json'):
        config = json.load(open(configFilename))
        self.username = config['username']
        self.password = config['password']

        self.actions = {}
        for r, message in config['responses'].iteritems():
            self.actions[re.compile(r)] = message

        self._r = praw.Reddit('Auto responder bot by /u/kragniz')
        self._r.login(self.username, self.password)

        self.messages = []

    def has_messages(self):
        self.messages = [m for m in self._r.get_unread()]
        return len(self.messages) > 0

    def respond(self, message):
        for r, messageText in self.actions.iteritems():
            if r.match(message.subject):
                self.log('New message from:', message.author)
                self.log('Subject:', message.subject)
                message.reply(messageText)
                message.mark_as_read()
                break

    def respond_to_messages(self):
        for m in self.messages:
            if not m.was_comment:
                self.respond(m)

    def log(self, *args):
        print '\033[94m' + time.asctime() + '\033[0m',
        print ' '.join([str(s) for s in args]) + '\033[0m'

if __name__ == '__main__':
    r = Responder()
    while True:
        try:
            time.sleep(10)
            if r.has_messages():
                r.respond_to_messages()
        except Exception, e:
            print r.log('Error raised:', e)
